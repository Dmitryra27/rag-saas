name: Deploy RAG SaaS to Yandex Cloud

on:
  push:
    branches: [main]

env:
  YC_CLOUD_ID: ${{ secrets.YC_CLOUD_ID }}
  YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install YC CLI
        run: |
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
          echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH

      - name: Restore service account key
        run: |
          echo '${{ secrets.YC_SERVICE_ACCOUNT_KEY }}' > key.json

      - name: Configure YC CLI
        run: |
          yc config set service-account-key key.json
          yc config set cloud-id $YC_CLOUD_ID
          yc config set folder-id $YC_FOLDER_ID

      - name: Verify YC auth
        run: yc iam whoami

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.6"

      - name: Terraform init
        run: |
          cd infra
          terraform init

      - name: Terraform apply
        run: |
          cd infra
          terraform apply -auto-approve \
            -var="yc_cloud_id=$YC_CLOUD_ID" \
            -var="yc_folder_id=$YC_FOLDER_ID" \
            -var="gigachat_client_id=${{ secrets.GIGACHAT_CLIENT_ID }}" \
            -var="gigachat_secret=${{ secrets.GIGACHAT_SECRET }}" \
            -var="jwt_secret=${{ secrets.JWT_SECRET }}" \
            -var="pg_password=${{ secrets.PG_PASSWORD }}"

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push backend image
        run: |
          docker build -t ghcr.io/${{ github.repository }}/backend:latest services/backend
          docker push ghcr.io/${{ github.repository }}/backend:latest

      - name: Get Kubernetes credentials
        run: yc managed-kubernetes cluster get-credentials rag-cluster --external

      - name: Install envsubst (for secret templating)
        run: sudo apt-get update && sudo apt-get install -y gettext

      - name: Deploy to Kubernetes
        run: |
          kubectl apply -f k8s/namespace.yaml

          # Encode secrets as base64
          export GIGACHAT_CLIENT_ID_B64=$(echo -n "${{ secrets.GIGACHAT_CLIENT_ID }}" | base64 -w 0)
          export GIGACHAT_SECRET_B64=$(echo -n "${{ secrets.GIGACHAT_SECRET }}" | base64 -w 0)
          export YC_API_KEY_B64=$(echo -n "${{ secrets.YC_API_KEY }}" | base64 -w 0)
          export JWT_SECRET_B64=$(echo -n "${{ secrets.JWT_SECRET }}" | base64 -w 0)

          # Render and apply Kubernetes secrets
          envsubst < k8s/secrets.yaml | kubectl apply -f -

          # Apply other manifests
          kubectl apply -f k8s/backend-deployment.yaml
          kubectl apply -f k8s/backend-service.yaml
